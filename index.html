<!DOCTYPE html>
<html lang="en">

<head>
    <title>MAMM Alert</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/alerts/web/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-messaging.js";
        import { getFirestore, setDoc, doc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyArrnKp3JfRV9HfdkGsfwIbu57YvsRStew",
            authDomain: "mamm-alerts.firebaseapp.com",
            projectId: "mamm-alerts",
            storageBucket: "mamm-alerts.firebasestorage.app",
            messagingSenderId: "812376016079",
            appId: "1:812376016079:web:62e9c74cba6c13ac47a3ba",
            measurementId: "G-FZH66DH45K"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const messaging = getMessaging(app);
        const db = getFirestore(app);

        let token = "";
        let server = "";

        let requestNotiPerms = async () => {
            if (Notification.permission === "granted") {
                return true;
            }

            let result = await Notification.requestPermission();

            if (result === "granted") {
                location.reload();
            } else {
                return false;
            }
        }

        let setupWorker = async () => {
            if ("serviceWorker" in navigator) {
                let worker = await navigator.serviceWorker.register("firebase-messaging-sw.js");

                return worker;
            } else {
                return null;
            }
        }

        // function 
        let setupFCM = async (worker) => {
            let id = await getToken(
                messaging,
                {
                    vapidKey: "BG4Yi5F1PprifQOyJtjTD1ShsoynoTbmsBpR-HAu20F0hPSTHZtQx89jipGswWSW6zJAWpUcaldQdHxGLcjsqSg",
                    serviceWorkerRegistration: worker,
                }
            );

            onMessage(messaging, (payload) => {
                console.log(
                    'Received message ',
                    payload
                );

                // Customize notification here
                const notificationTitle = payload.data["title"];

                let notificationIcon = '';
                if(payload.data["type"].toLowerCase() == "up"){
                    notificationIcon = 'web/good.png' ;
                }
                else{
                    notificationIcon = 'web/failure.png';
                }
                console.log(payload.data["type"]);

                const notificationOptions = {
                    body: payload.data["body"],
                    icon: notificationIcon,
                    data: {
                        url: "/history"
                    }
                };

                worker.showNotification(notificationTitle, notificationOptions);
                console.log(payload.data)
                // localStorage.setItem(payload.data, JSON.stringify(payload.data))
            });

            worker.addEventListener('notificationclick', (event) => {
                event.notification.close();

                // Check existing tab to focus on
                event.waitUntil(
                    clients
                        // https://developer.mozilla.org/en-US/docs/Web/API/Clients/matchAll
                        .matchAll({ type: 'window', includeUncontrolled: true })
                        .then(function (clientList) {
                            const url = event.notification.data.url;

                            if (!url) return;

                            // Focus on existing tab
                            for (const client of clientList) {
                                if (client.url.includes(url) && 'focus' in client) {
                                    return client.focus();
                                }
                            }

                            if (clients.openWindow) {
                                return clients.openWindow(url);
                            }
                        })
                );
            });

            return id;
        }

        let setup = async () => {
            let allowed = await requestNotiPerms();

            if (allowed) {

                let worker = await setupWorker();

                if (worker != null) {
                    token = await setupFCM(worker);
                    console.log(token);
                }

                let data = {};

                if (token) {
                    document.querySelector("#prompt").style.display = "none";
                    document.querySelector("#notification-id").value = token;
                    document.querySelector("#copy-button").removeAttribute("disabled");
                    document.querySelector("#save-button").addEventListener(
                        "click", () => saveToDB(token)
                    );
                    document.querySelector("#save-button").removeAttribute("disabled");
                }
            }
        }

        let saveToDB = async (token) => {
            await setDoc(doc(db, "tokens", token), {
                created: Date.now().toLocaleString()
            })

            alert('Notification ID saved!');
            document.querySelector("#save-button").setAttribute("disabled", true);
        };

        setup();
    </script>
    <style>
        * {
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0px;
        }

        #prompt {
            width: 100%;
            height: 100%;
            padding: 16px;
            position: fixed;
            background-color: #ffffff;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
</head>

<body class="bg-light d-flex justify-content-center align-items-center">
    <div id="prompt">
        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="card p-4 text-center col-md-6 m-2">
        <h4 class="notification-text mb-3">Notification ID</h4>

        <div class="d-flex justify-content-between gap-1">
            <input type="text" id="notification-id" class="form-control text-center mb-3 flex-grow-1"
            placeholder="Please wait for the token to generate" readonly>
            <button class="btn btn-secondary mb-3 flex-shrink-1" id="copy-button" disabled>Copy</button>
        </div>

        <button class="btn btn-primary w-100 mb-3" id="save-button" disabled>Save</button>

        <p class="text-muted small mb-0">
            Use your token on the <a target="_blank" rel="noopener noreferrer" href="/alerts/register">registration site</a> to complete your setup.
        </p>
    </div>

    <script>
        document.getElementById('copy-button').addEventListener('click', async () => {
            const input = document.getElementById('notification-id');

            try {
                await navigator.clipboard.writeText(input.value);
                alert('Notification ID copied to clipboard!');
            } catch (err) {
                alert('Failed to copy text.');
            }
        });
    </script>
</body>

</html>