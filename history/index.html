<html>

<head>
    <title>MAMM Alert History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="../web/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="../localforage.min.js"></script>

    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f5f9fc;
        }

        h1 {
            color: #154360;
            margin-bottom: 20px;
        }

        .machine-group {
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 10px;
            background-color: #d6eaf8;
            /* light blue */
            border: 1px solid #85c1e9;
        }

        .machine-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1b4f72;
            /* darker blue */
            border-bottom: 2px solid #2980b9;
            padding-bottom: 6px;
        }

        .value {
            background: #ebf5fb;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-family: monospace;
            white-space: pre-wrap;
        }

        #itemsList {
            max-height: 800px;
            overflow-y: auto;
        }
    </style>
    <script>
        fetch('/register/config.json')
            .then(res => res.json())
            .then(config => {
                const machines = config.subscriptions; // ["AMA","BRA","MOT","BTP","FRA"]
                const groups = {};

                // Init groups + Others
                machines.forEach(m => groups[m] = []);
                groups["Others"] = [];

                // Iterate localforage
                localforage.iterate(function (value, key) {
                    if (key === "Information-History" && Array.isArray(value)) {
                        value.forEach(item => {
                            const machine = item.machine;
                            if (machines.includes(machine)) {
                                groups[machine].push(item);
                            } else {
                                groups["Others"].push(item);
                            }
                        });
                    }
                }).then(() => {
                    // Render each group
                    for (const machine of machines) {
                        if (groups[machine].length > 0) renderGroup(machine, groups[machine]);
                    }
                    if (groups["Others"].length > 0) renderGroup("Others", groups["Others"]);
                    console.log("Rendering completed");
                }).catch(err => console.error(err));

                function renderGroup(machine, items) {
                    const container = document.getElementById("itemsList");

                    // Wrapper div untuk machine group
                    const groupDiv = document.createElement("div");
                    groupDiv.className = "machine-group";

                    // Title / header clickable
                    const title = document.createElement("div");
                    title.className = "machine-title";
                    title.textContent = `Machine: ${machine}`;
                    title.style.cursor = "pointer"; // nampak clickable
                    groupDiv.appendChild(title);

                    // Container untuk items yang boleh dilipat
                    const itemsContainer = document.createElement("div");
                    itemsContainer.style.display = "none"; // âœ… tutup by default

                    // Sort items by time descending (newest first)
items.sort((a, b) => new Date(b.time) - new Date(a.time));

items.forEach(obj => {
    const valDiv = document.createElement("div");
    valDiv.className = "value";
    valDiv.textContent = JSON.stringify(obj, null, 2);

    if (obj.type === "up") {
        valDiv.style.backgroundColor = "#d4edda";
        valDiv.style.color = "#155724";
    } else if (obj.type === "down") {
        valDiv.style.backgroundColor = "#f8d7da";
        valDiv.style.color = "#721c24";
    } else {
        valDiv.style.backgroundColor = "#ebf5fb";
        valDiv.style.color = "#000";
    }

    // Letak atas supaya yang terbaru di atas
    itemsContainer.appendChild(valDiv); // sebab dah sort, appendChild pun ok
});


                    groupDiv.appendChild(itemsContainer);
                    container.appendChild(groupDiv);

                    // Toggle display on click
                    title.addEventListener("click", () => {
                        if (itemsContainer.style.display === "none") {
                            itemsContainer.style.display = "block";
                        } else {
                            itemsContainer.style.display = "none";
                        }
                    });
                }
            })
            .catch(err => console.error("Failed to load config.json:", err));
    </script>
</head>

<body>
    <h1>Notifications History</h1>
    <div id="itemsList"></div>
</body>

</html>