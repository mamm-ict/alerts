<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>MAMM Alert Registration Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/web/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        // ---------------- Firebase ----------------
        const firebaseConfig = {
            apiKey: "AIzaSyArrnKp3JfRV9HfdkGsfwIbu57YvsRStew",
            authDomain: "mamm-alerts.firebaseapp.com",
            projectId: "mamm-alerts",
            storageBucket: "mamm-alerts.firebasestorage.app",
            messagingSenderId: "812376016079",
            appId: "1:812376016079:web:62e9c74cba6c13ac47a3ba",
            measurementId: "G-FZH66DH45K"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ---------------- Helpers ----------------
        const shortenToken = t => t.length <= 25 ? t : t.substring(0, 10) + "..." + t.slice(-6);
        const tokenInput = document.querySelector("#token-input");

        // ---------------- Date Parsing ----------------
        function parseDate(str) {
            if (!str) return new Date();
            if (typeof str === "number") return new Date(str);
            if (typeof str === "string") {
                const iso = new Date(str);
                if (!isNaN(iso.getTime())) return iso;
                const m = str.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})[ ,]+(\d{1,2}):(\d{2}):(\d{2})/);
                if (m) {
                    const [_, dd, mm, yyyy, hh, min, ss] = m.map((v, i) => i > 0 ? +v : v);
                    return new Date(yyyy, mm - 1, dd, hh, min, ss);
                }
            }
            return new Date();
        }

        // ---------------- Token Handling ----------------
        async function getTokenList() {
            const snapshot = await getDocs(collection(db, "tokens"));
            const tokens = snapshot.docs.map(docSnap => {
                const data = docSnap.data();
                const date = parseDate(data.created);
                return { id: docSnap.id, ts: date.getTime(), displayStr: formatDate(date) };
            });
            tokens.sort((a, b) => b.ts - a.ts);
            return tokens;
        }

        function formatDate(date) {
            const pad = n => n.toString().padStart(2, "0");
            return `${pad(date.getDate())}/${pad(date.getMonth() + 1)}/${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
        }

        // ---------------- Subscription Handling ----------------
        async function getSubscriptions(token) {
            if (!token) return [];
            const tokenDoc = await getDoc(doc(db, "tokens", token));
            return tokenDoc.exists() ? tokenDoc.data().subscriptions || [] : [];
        }

        async function subToTopic(server, topic) {
            const token = tokenInput.value;
            if (!token || token.length < 128) { alert("Please enter a valid token"); return false; }

            const ok = confirm(`Subscribe token to "${topic}"?`);
            if (!ok) return false;

            const res = await fetch(server + "/subscribe", {
                method: "POST",
                body: JSON.stringify({ token, topic }),
                mode: "cors"
            });

            if (res.status === 200) {
                await setDoc(doc(db, "tokens", token), {
                    subscriptions: arrayUnion(topic)
                }, { merge: true });
                return true;
            } else {
                alert("Failed to subscribe");
                return false;
            }
        }

        async function toggleSubscription(token, topic, btn, server) {
            if (!token || token.length < 128) return;

            const subs = await getSubscriptions(token);
            const isSubscribed = subs.includes(topic);

            const ok = confirm(isSubscribed ?
                `Unsubscribe token from "${topic}"?` :
                `Subscribe token to "${topic}"?`
            );
            if (!ok) return;

           if (isSubscribed) {
    // Call backend unsubscribe
    const res = await fetch(server + "/unsubscribe", {
        method: "POST",
        body: JSON.stringify({ token, topic }),
        mode: "cors"
    });
    if (res.status === 200) {
        await setDoc(doc(db, "tokens", token), { subscriptions: subs.filter(t => t !== topic) }, { merge: true });
        btn.classList.remove("btn-success");
        btn.classList.add("btn-primary");
        btn.innerText = topic;
    } else {
        alert("Failed to unsubscribe");
    }
} 
 else {
                // Subscribe
                const res = await fetch(server + "/subscribe", {
                    method: "POST",
                    body: JSON.stringify({ token, topic }),
                    mode: "cors"
                });
                if (res.status === 200) {
                    await setDoc(doc(db, "tokens", token), { subscriptions: arrayUnion(topic) }, { merge: true });
                    btn.classList.remove("btn-primary");
                    btn.classList.add("btn-success");
                    btn.innerText = `${topic} ✓`;
                    btn.disabled = false; // leave enabled for toggle
                } else {
                    alert("Failed to subscribe");
                }
            }
        }

        async function renderSubscriptions(token, data) {
            const list = document.querySelector("#subscribe-list");
            list.innerHTML = "";
            list.style.display = "flex";

            const subs = await getSubscriptions(token);

            data.subscriptions.forEach(topic => {
                const div = document.createElement("div");
                div.classList.add("col-md-4", "col-12", "p-1");

                const btn = document.createElement("button");
                btn.classList.add("btn", "p-3", "w-100");

                if (subs.includes(topic)) {
                    btn.classList.add("btn-success");
                    btn.innerText = `${topic} ✓`;
                } else {
                    btn.classList.add("btn-primary");
                    btn.innerText = topic;
                }

                btn.addEventListener("click", () => toggleSubscription(token, topic, btn, data.server));

                div.appendChild(btn);
                list.appendChild(div);
            });
        }


        // ---------------- Setup ----------------
        async function setup() {
            const data = await fetch("config.json").then(r => r.ok ? r.json() : {});
            const tokens = await getTokenList();

            const tokenList = document.querySelector("#tokens");
            tokenList.innerHTML = "";
            const selector = document.querySelector("#selector");
            selector.removeAttribute("disabled");

            tokens.forEach((t, index) => {
                const li = document.createElement("li");
                const btn = document.createElement("button");
                btn.classList.add("dropdown-item", "text-truncate");
                btn.title = t.id;
                btn.innerHTML = `${shortenToken(t.id)} (${t.displayStr})`;

                if (index === 0) {
                    const badge = document.createElement("span");
                    badge.classList.add("badge", "bg-success", "ms-1");
                    badge.style.fontSize = "0.65rem";
                    badge.innerText = "NEW";
                    btn.appendChild(badge);
                }
                
                btn.addEventListener("click", () => {
                    tokenInput.value = t.id;
                    renderSubscriptions(t.id, data);
                });

                li.appendChild(btn);
                li.classList.add("px-2", "w-100");
                tokenList.appendChild(li);
            });
        }

        // ---------------- Clear Button ----------------
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelector("#clear-button").addEventListener("click", () => {
                tokenInput.value = "";
                document.querySelector("#subscribe-list").innerHTML = "";
            });
            setup();
        });

    </script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
        }

        #tokens {
            max-height: 200px;
            overflow-y: auto;
        }

        #subscribe-list {
            margin-top: 20px;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-5">
        <h1 class="text-center mb-4">MAMM ALERT SUBSCRIPTION MANAGER</h1>

        <div class="input-group mb-3 d-flex flex-column justify-content-between gap-2">
            <div class="dropdown">
                <button id="selector" class="btn btn-secondary dropdown-toggle w-100" type="button"
                    data-bs-toggle="dropdown" disabled>Select Token</button>
                <ul class="dropdown-menu w-100" id="tokens"></ul>
            </div>
            <div class="d-flex justify-content-between gap-1">
                <input type="text" id="token-input" class="form-control w-100 rounded"
                    placeholder="Enter Notification Token">
                <button class="btn btn-danger flex-shrink-1" id="clear-button">CLEAR</button>
            </div>
        </div>

        <div id="subscribe-list" class="d-flex flex-wrap"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>